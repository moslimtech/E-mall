-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…ÙˆÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- ØªØ¶Ù…ÙŠÙ† Tailwind CSS Ù„ØªØµÙ…ÙŠÙ… Ø³Ø±ÙŠØ¹ ÙˆØ¬Ù…ÙŠÙ„ -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Cairo', sans-serif; background:#f9f9f9; margin:0; padding:15px; }
  h1 { text-align:center; margin-bottom:15px; color: #333; }
  .filter-bar { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:20px; }
  .filter-bar select { padding:8px; font-size:14px; border-radius:5px; border:1px solid #ddd; background-color: #fff; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px; }
  .card { background:#fff; border-radius:10px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); position:relative; text-align:center; transition: transform 0.2s ease-in-out; }
  .card:hover { transform: translateY(-5px); }
  .status { width:12px; height:12px; border-radius:50%; position:absolute; top:8px; left:8px; border: 1px solid rgba(0,0,0,0.1); }
  .status.open { background:green; } .status.closed { background:red; } .status.prayer { background:orange; }
  .badge { position:absolute; top:8px; right:8px; background:#e91e63; color:white; padding:2px 6px; font-size:11px; border-radius:8px; }
  .card img { width:100%; height:90px; object-fit:cover; border-radius:6px; margin-bottom:6px; }
  .card h3 { font-size:14px; margin:5px 0; color: #333; }
  .card p { font-size:12px; color:#555; margin:2px 0; }
  .contact { display:flex; justify-content:center; gap:10px; margin-top:6px; }
  .contact a { font-size:16px; color:#4caf50; text-decoration:none; transition: color 0.2s ease-in-out; }
  .contact a:hover { color: #2e7d32; }
  .btn { background:#2196f3; color:white; padding:5px 8px; border:none; border-radius:5px; font-size:13px; cursor:pointer; margin-top:8px; transition: background-color 0.2s ease-in-out; }
  .btn:hover { background:#1976d2; }
  
  /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
  .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2196f3; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø¬Ø°Ø§Ø¨ */
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  .status-message {
      text-align: center;
      padding: 10px;
      color: #555;
  }
</style>
</head>
<body>
<h1>Ø§Ù„Ù…ÙˆÙ„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h1>
<div class="filter-bar">
  <select id="filter-activity" class="rounded-md"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</option></select>
  <select id="filter-city" class="rounded-md"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option></select>
</div>
<div class="status-message" id="globalStatusMessage">
    <div class="loading-spinner"></div>
    <p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>
<div class="grid" id="placesGrid"></div>

<script>
// ğŸš¨ Ù‡Ø§Ù…: Ù‡Ø°Ø§ Ù‡Ùˆ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø§Ù„Ø°ÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡ Ù…Ù† Google Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbxkKrHyeEAgSkLz2QHzSgA5w09dIvfFJgDUMkP373f-VVAZmahHalr0GOYojqK41x6E/exec"; 

// ÙØªØ±Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (Ù…Ø«Ø§Ù„: ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù)
// Ù„Ø§ ØªØ¬Ø¹Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ ØªØ¬Ø§ÙˆØ² Ø­ØµØµ Google Apps Script API.
const POLLING_INTERVAL_MS = 10000; // 10 Ø«ÙˆØ§Ù†Ù

let allPlacesData = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§
let allAdsData = [];    // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§
let filtersPopulated = false; // Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙÙ„Ø§ØªØ± Ù‚Ø¯ ØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§

const placesGrid = document.getElementById("placesGrid");
const activitySelect = document.getElementById("filter-activity");
const citySelect = document.getElementById("filter-city");
const globalStatusMessage = document.getElementById('globalStatusMessage');

/**
 * ÙŠØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Apps Script Web App API.
 * @returns {Promise<Object|null>} ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ† ÙˆØ§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§ØªØŒ Ø£Ùˆ null ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£.
 */
async function fetchData() {
    globalStatusMessage.innerHTML = '<div class="loading-spinner"></div><p>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>';
    globalStatusMessage.style.display = 'block'; // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„

    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (response.ok && !data.error) {
            globalStatusMessage.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
            return data;
        } else {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API:', data.error || response.statusText);
            globalStatusMessage.innerHTML = `<p class="text-red-500">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${data.error || response.statusText}</p>`;
            return null;
        }
    } catch (error) {
        console.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        globalStatusMessage.innerHTML = `<p class="text-red-500">Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${error.message}</p>`;
        return null;
    }
}

/**
 * ÙŠÙ‚ÙˆÙ… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± (Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ù…Ø¯Ù†) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.
 * @param {Array<Object>} places - Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ†.
 */
function populateFilters(places) {
    if (filtersPopulated) return; // Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ¹Ø¨Ø¦Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ØªÙ… Ø°Ù„Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„

    const activitySet = [...new Set(places.map(p => p["Ù…Ø¹Ø±Ù Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·"]))].sort();
    const citySet = [...new Set(places.map(p => p["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"]))].sort();

    // Ù…Ø³Ø­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø®ÙŠØ§Ø± "Ø§Ù„ÙƒÙ„")
    activitySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</option>';
    citySelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>';

    activitySet.forEach(a => {
        if (a) activitySelect.innerHTML += `<option value="${a}">${a}</option>`;
    });
    citySet.forEach(c => {
        if (c) citySelect.innerHTML += `<option value="${c}">${c}</option>`;
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ÙÙ„Ø§ØªØ±
    activitySelect.addEventListener("change", () => renderPlaces(allPlacesData, allAdsData));
    citySelect.addEventListener("change", () => renderPlaces(allPlacesData, allAdsData));

    filtersPopulated = true;
}

/**
 * ÙŠÙ‚ÙˆÙ… Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.
 * @param {Array<Object>} places - Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù…Ø§ÙƒÙ†.
 * @param {Array<Object>} ads - Ù…ØµÙÙˆÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.
 */
function renderPlaces(places, ads) {
  placesGrid.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

  const activityFilter = activitySelect.value;
  const cityFilter = citySelect.value;

  const filteredPlaces = places.filter(p =>
    (!activityFilter || p["Ù…Ø¹Ø±Ù Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·"] === activityFilter) &&
    (!cityFilter || p["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"].toString() === cityFilter)
  );

  if (filteredPlaces.length === 0) {
    placesGrid.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø§ÙƒÙ† Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±Ø©.</p>';
    return;
  }

  filteredPlaces.forEach(place => {
    const statusClass = place["Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù†"] === "Ù…ÙØªÙˆØ­ Ø§Ù„Ø§Ù†" ? "open" :
                        place["Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ù†"] === "Ù…ØºÙ„Ù‚ Ù„Ù„ØµÙ„Ø§Ø©" ? "prayer" : "closed";

    const hasAd = ads.some(ad => ad["Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙƒØ§Ù†"] === place["Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙƒØ§Ù†"] && ad["Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¹Ù„Ø§Ù†"] === "Ù†Ø´Ø·");

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="status ${statusClass}"></div>
      ${hasAd ? '<div class="badge">Ø¹Ø±Ø¶</div>' : ""}
      <img src="${place["Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙƒØ§Ù†"] || 'https://placehold.co/150x90/cccccc/333333?text=Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©'}" 
           alt="Ø´Ø¹Ø§Ø±" 
           onerror="this.onerror=null;this.src='https://placehold.co/150x90/cccccc/333333?text=Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©';">
      <h3>${place["Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†"] || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù…"}</h3>
      <p>Ø§Ù„Ù†Ø´Ø§Ø·: ${place["Ù…Ø¹Ø±Ù Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·"] || "-"}</p>
      <p>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${place["Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©"] || "-"}</p>
      <div class="contact">
        ${place["Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„"] ? `<a href="tel:${place["Ø±Ù‚Ù… Ø§Ù„ØªÙˆØ§ØµÙ„"]}" class="text-green-500 hover:text-green-700"><i class="fas fa-phone"></i></a>` : ""}
        ${place["Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨"] ? `<a href="${place["Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨"]}" target="_blank" class="text-green-500 hover:text-green-700"><i class="fab fa-whatsapp"></i></a>` : ""}
      </div>
      <button class="btn" onclick="location.href='ads.html?place=${place["Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙƒØ§Ù†"]}'">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</button>
    `;
    placesGrid.appendChild(card);
  });
}

/**
 * ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±ÙŠØ©.
 */
async function init() {
    const newData = await fetchData();
    if (newData) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ ØªØºÙŠØ±Øª Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if (JSON.stringify(newData.places) !== JSON.stringify(allPlacesData) ||
            JSON.stringify(newData.ads) !== JSON.stringify(allAdsData)) {
            
            allPlacesData = newData.places;
            allAdsData = newData.ads;

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙ„Ø§ØªØ± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ù…Ù† Ù‚Ø¨Ù„
            populateFilters(allPlacesData);
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            renderPlaces(allPlacesData, allAdsData);
            
            console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.");
        } else {
            console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù… ØªØªØºÙŠØ±. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«.");
        }
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
    init(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    setInterval(init, POLLING_INTERVAL_MS);
});
</script>
</body>
</html>
<!--
