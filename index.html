-->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>المول الإلكتروني</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- تضمين Tailwind CSS لتصميم سريع وجميل -->
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Cairo', sans-serif; background:#f9f9f9; margin:0; padding:15px; }
  h1 { text-align:center; margin-bottom:15px; color: #333; }
  .filter-bar { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-bottom:20px; }
  .filter-bar select { padding:8px; font-size:14px; border-radius:5px; border:1px solid #ddd; background-color: #fff; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px; }
  .card { background:#fff; border-radius:10px; padding:10px; box-shadow:0 2px 6px rgba(0,0,0,.1); position:relative; text-align:center; transition: transform 0.2s ease-in-out; }
  .card:hover { transform: translateY(-5px); }
  .status { width:12px; height:12px; border-radius:50%; position:absolute; top:8px; left:8px; border: 1px solid rgba(0,0,0,0.1); }
  .status.open { background:green; } .status.closed { background:red; } .status.prayer { background:orange; }
  .badge { position:absolute; top:8px; right:8px; background:#e91e63; color:white; padding:2px 6px; font-size:11px; border-radius:8px; }
  .card img { width:100%; height:90px; object-fit:cover; border-radius:6px; margin-bottom:6px; }
  .card h3 { font-size:14px; margin:5px 0; color: #333; }
  .card p { font-size:12px; color:#555; margin:2px 0; }
  .contact { display:flex; justify-content:center; gap:10px; margin-top:6px; }
  .contact a { font-size:16px; color:#4caf50; text-decoration:none; transition: color 0.2s ease-in-out; }
  .contact a:hover { color: #2e7d32; }
  .btn { background:#2196f3; color:white; padding:5px 8px; border:none; border-radius:5px; font-size:13px; cursor:pointer; margin-top:8px; transition: background-color 0.2s ease-in-out; }
  .btn:hover { background:#1976d2; }
  
  /* مؤشر التحميل */
  .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #2196f3; /* لون أزرق جذاب */
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
  }
  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }
  .status-message {
      text-align: center;
      padding: 10px;
      color: #555;
  }
</style>
</head>
<body>
<h1>المول الإلكتروني</h1>
<div class="filter-bar">
  <select id="filter-activity" class="rounded-md"><option value="">كل الأنشطة</option></select>
  <select id="filter-city" class="rounded-md"><option value="">كل المدن</option></select>
</div>
<div class="status-message" id="globalStatusMessage">
    <div class="loading-spinner"></div>
    <p>جارٍ تحميل البيانات...</p>
</div>
<div class="grid" id="placesGrid"></div>

<script>
// 🚨 هام: هذا هو رابط الـ Web App الخاص بك الذي حصلت عليه من Google Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbxkKrHyeEAgSkLz2QHzSgA5w09dIvfFJgDUMkP373f-VVAZmahHalr0GOYojqK41x6E/exec"; 

// فترة الاستعلام بالمللي ثانية (مثال: كل 10 ثوانٍ)
// لا تجعل هذه القيمة صغيرة جداً لتجنب تجاوز حصص Google Apps Script API.
const POLLING_INTERVAL_MS = 10000; // 10 ثوانٍ

let allPlacesData = []; // لتخزين جميع بيانات الأماكن التي تم جلبها
let allAdsData = [];    // لتخزين جميع بيانات الإعلانات التي تم جلبها
let filtersPopulated = false; // لتتبع ما إذا كانت الفلاتر قد تم تعبئتها

const placesGrid = document.getElementById("placesGrid");
const activitySelect = document.getElementById("filter-activity");
const citySelect = document.getElementById("filter-city");
const globalStatusMessage = document.getElementById('globalStatusMessage');

/**
 * يجلب البيانات من Google Apps Script Web App API.
 * @returns {Promise<Object|null>} كائن يحتوي على بيانات الأماكن والإعلانات، أو null في حالة الخطأ.
 */
async function fetchData() {
    globalStatusMessage.innerHTML = '<div class="loading-spinner"></div><p>جارٍ تحميل البيانات...</p>';
    globalStatusMessage.style.display = 'block'; // عرض رسالة التحميل

    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (response.ok && !data.error) {
            globalStatusMessage.style.display = 'none'; // إخفاء رسالة التحميل عند النجاح
            return data;
        } else {
            console.error('خطأ في جلب البيانات من API:', data.error || response.statusText);
            globalStatusMessage.innerHTML = `<p class="text-red-500">خطأ في جلب البيانات: ${data.error || response.statusText}</p>`;
            return null;
        }
    } catch (error) {
        console.error('حدث خطأ أثناء جلب البيانات:', error);
        globalStatusMessage.innerHTML = `<p class="text-red-500">حدث خطأ غير متوقع: ${error.message}</p>`;
        return null;
    }
}

/**
 * يقوم بتعبئة الفلاتر (الأنشطة والمدن) مرة واحدة.
 * @param {Array<Object>} places - مصفوفة بيانات الأماكن.
 */
function populateFilters(places) {
    if (filtersPopulated) return; // لا تقم بالتعبئة مرة أخرى إذا تم ذلك بالفعل

    const activitySet = [...new Set(places.map(p => p["معرف نوع النشاط"]))].sort();
    const citySet = [...new Set(places.map(p => p["المدينة"]))].sort();

    // مسح الخيارات القديمة (باستثناء خيار "الكل")
    activitySelect.innerHTML = '<option value="">كل الأنشطة</option>';
    citySelect.innerHTML = '<option value="">كل المدن</option>';

    activitySet.forEach(a => {
        if (a) activitySelect.innerHTML += `<option value="${a}">${a}</option>`;
    });
    citySet.forEach(c => {
        if (c) citySelect.innerHTML += `<option value="${c}">${c}</option>`;
    });

    // إضافة مستمعي الأحداث للفلاتر
    activitySelect.addEventListener("change", () => renderPlaces(allPlacesData, allAdsData));
    citySelect.addEventListener("change", () => renderPlaces(allPlacesData, allAdsData));

    filtersPopulated = true;
}

/**
 * يقوم بعرض الأماكن بناءً على البيانات والفلاتر المحددة.
 * @param {Array<Object>} places - مصفوفة بيانات الأماكن.
 * @param {Array<Object>} ads - مصفوفة بيانات الإعلانات.
 */
function renderPlaces(places, ads) {
  placesGrid.innerHTML = ""; // مسح الشبكة الحالية

  const activityFilter = activitySelect.value;
  const cityFilter = citySelect.value;

  const filteredPlaces = places.filter(p =>
    (!activityFilter || p["معرف نوع النشاط"] === activityFilter) &&
    (!cityFilter || p["المدينة"].toString() === cityFilter)
  );

  if (filteredPlaces.length === 0) {
    placesGrid.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full">لا توجد أماكن مطابقة لمعايير الفلترة.</p>';
    return;
  }

  filteredPlaces.forEach(place => {
    const statusClass = place["حالة المكان الان"] === "مفتوح الان" ? "open" :
                        place["حالة المكان الان"] === "مغلق للصلاة" ? "prayer" : "closed";

    const hasAd = ads.some(ad => ad["معرف المكان"] === place["معرف المكان"] && ad["حالة الاعلان"] === "نشط");

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="status ${statusClass}"></div>
      ${hasAd ? '<div class="badge">عرض</div>' : ""}
      <img src="${place["رابط صورة شعار المكان"] || 'https://placehold.co/150x90/cccccc/333333?text=لا توجد صورة'}" 
           alt="شعار" 
           onerror="this.onerror=null;this.src='https://placehold.co/150x90/cccccc/333333?text=خطأ في الصورة';">
      <h3>${place["اسم المكان"] || "لا يوجد اسم"}</h3>
      <p>النشاط: ${place["معرف نوع النشاط"] || "-"}</p>
      <p>المدينة: ${place["المدينة"] || "-"}</p>
      <div class="contact">
        ${place["رقم التواصل"] ? `<a href="tel:${place["رقم التواصل"]}" class="text-green-500 hover:text-green-700"><i class="fas fa-phone"></i></a>` : ""}
        ${place["رابط واتساب"] ? `<a href="${place["رابط واتساب"]}" target="_blank" class="text-green-500 hover:text-green-700"><i class="fab fa-whatsapp"></i></a>` : ""}
      </div>
      <button class="btn" onclick="location.href='ads.html?place=${place["معرف المكان"]}'">عرض الإعلانات</button>
    `;
    placesGrid.appendChild(card);
  });
}

/**
 * وظيفة التهيئة الأولية وجلب البيانات الدورية.
 */
async function init() {
    const newData = await fetchData();
    if (newData) {
        // التحقق مما إذا كانت البيانات قد تغيرت قبل التحديث
        if (JSON.stringify(newData.places) !== JSON.stringify(allPlacesData) ||
            JSON.stringify(newData.ads) !== JSON.stringify(allAdsData)) {
            
            allPlacesData = newData.places;
            allAdsData = newData.ads;

            // تعبئة الفلاتر فقط إذا لم يتم تعبئتها من قبل
            populateFilters(allPlacesData);
            
            // إعادة عرض الأماكن بناءً على البيانات الجديدة والفلاتر الحالية
            renderPlaces(allPlacesData, allAdsData);
            
            console.log("البيانات تم تحديثها وعرضها بنجاح.");
        } else {
            console.log("البيانات لم تتغير. لا حاجة للتحديث.");
        }
    }
}

// تشغيل التهيئة الأولية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
    init(); // جلب البيانات لأول مرة
    // بدء الاستعلام المتكرر بعد التحميل الأولي
    setInterval(init, POLLING_INTERVAL_MS);
});
</script>
</body>
</html>
<!--
